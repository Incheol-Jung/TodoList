<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Todo List</title>
        <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.css" />
        <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid-theme.min.css" />
        <link rel="stylesheet" href="https://code.jquery.com/ui/1.11.2/themes/cupertino/jquery-ui.css">
        <script src="https://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
        <script src="https://code.jquery.com/ui/1.11.2/jquery-ui.min.js"></script>
        <script src="http://ajax.aspnetcdn.com/ajax/jquery.validate/1.9/jquery.validate.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.js"></script>
        <script src="https://unpkg.com/moment"></script>
    </head>
    <body>
        1. 검색(조회, 페이징)
        2. 수정(참조가능)
        3. 추가(참조가능)
        4. 삭제
        <div class="search-container">
            <div class="search-row">
                <div class="search-column">
                    <label>Task</label>
                    <input type="text" id="search-task">
                </div>
                <div class="search-column">
                    <label>Created Date</label>
                    <input type="date" id="search-createdDate">
                </div>
                <div class="search-column">
                    <label>Updated Date</label>
                    <input type="date" id="search-updatedDate">
                </div>
            </div>
            <div class="search-btn-row">
                <button id="testBtn">Search</button>
            </div>
        </div>
        <div id="jsGrid"></div>
        <div class="ui-dialog ui-widget ui-widget-content ui-corner-all ui-front ui-draggable ui-resizable" tabindex="-1" role="dialog" aria-describedby="detailsDialog" aria-labelledby="ui-id-1" style="position: absolute;height: auto;width: 400px;top: 192px;left: 289px;display: none;"><div class="ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix ui-draggable-handle"><span id="ui-id-1" class="ui-dialog-title">Edit Client</span><button type="button" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-icon-only ui-dialog-titlebar-close" role="button" title="Close"><span class="ui-button-icon-primary ui-icon ui-icon-closethick"></span><span class="ui-button-text">Close</span></button></div><div id="detailsDialog" class="ui-dialog-content ui-widget-content" style="width: auto; min-height: 93px; max-height: none; height: auto;">
            <form id="detailsForm" novalidate="novalidate">
                <div class="details-form-field">
                    <label for="todoId">ID:</label>
                    <input id="todoId" name="todoId" type="number" class="valid" readonly>
                </div>
                <div class="details-form-field">
                    <label for="task">Task:</label>
                    <input id="task" name="task" type="text" class="valid">
                </div>
                <div class="details-form-field">
                    <label for="referenceIds">Reference Ids:</label>
                    <input id="referenceIds" name="referenceIds" type="text" class="valid">
                </div>
                <div class="details-form-field">
                    <label for="createdDate">Created Date:</label>
                    <input id="createdDate" name="createdDate" type="text" class="valid" readonly>
                </div>
                <div class="details-form-field">
                    <label for="updatedDate">Updated Date:</label>
                    <input id="updatedDate" name="updatedDate" type="text" class="valid" readonly>
                </div>
                <div class="details-form-field">
                    <label for="isDone">Is Done</label>
                    <input id="isDone" name="isDone" type="checkbox">
                </div>
                <div class="details-form-field">
                    <button type="submit" id="save">Save</button>
                </div>
            </form>
        </div>
    </body>
    <script>
        $(function() {

            $("#pager").on("change", function() {
                var page = parseInt($(this).val(), 10);
                $("#jsGrid").jsGrid("openPage", page);
            });
        
            $("#jsGrid").jsGrid({
                width: "100%",
                height: "400px",
            
                editing: true,
                autoload: true,
                paging: true,

                pageIndex: 1,
                pageSize: 10,
                pageButtonCount: 10,
                
                controller: {
                    loadData: function(parameters) {
                        var d = $.Deferred();
                        $.ajax({
                            url: "http://localhost:29801/todos"
                            ,data:parameters
                            ,dataType: "json"
                        }).done(function(response) {
                            if(response.success) d.resolve(response.data);
                            else {
                                alert(response.message);
                                d.reject();
                            }
                        });
        
                        return d.promise();
                    },
                    insertItem: function(parameters) {
                        var d = $.Deferred();
                        $.ajax({
                            url: "http://localhost:29801/todos"
                            ,type: "POST"
                            ,contentType: "application/json; charset=utf-8"
                            ,data: JSON.stringify(parameters)
                            ,dataType: "json"
                        }).done(function(response) {
                            if(response.success) d.resolve(response.data);
                            else {
                                alert(response.message);
                                d.reject();
                            }
                        });
        
                        return d.promise();
                    },
                    updateItem: function(parameters) {
                        var d = $.Deferred();
                        $.ajax({
                            url: "http://localhost:29801/todos/"+parameters.todoId
                            ,type: "PUT"
                            ,contentType: "application/json; charset=utf-8"
                            ,data: JSON.stringify(parameters)
                            ,dataType: "json"
                        }).done(function(response) {
                            if(response.success) d.resolve(response.data);
                            else {
                                alert(response.message);
                                d.reject();
                            }
                        });
        
                        return d.promise();
                    },
                    deleteItem: function(parameters) {
                        var d = $.Deferred();
                        $.ajax({
                            url: "http://localhost:29801/todos/"+parameters.todoId
                            ,type: "DELETE"
                            ,dataType: "json"
                        }).done(function(response) {
                            if(response.success) d.resolve(response.data);
                            else {
                                alert(response.message);
                                d.reject();
                            }
                        });
        
                        return d.promise();
                    }
                },

        
                fields: [
                    { name: "todoId", title: "ID", type: "number", width: 50, validate: "required" },
                    { name: "task", title: "Task", type: "text", width: 150 },
                    { name: "referenceIds", title: "Reference Ids", type: "text", width: 100,
                        itemTemplate: function(value) {
                            return jQuery.isEmptyObject(value) ? "" : value.map(id => '@'+id+'&nbsp;');
                        }
                    },
                    { name: "createdDate", title: "Created Date", type: "text", width: 200, readOnly:true,
                        itemTemplate: function(value) {
                            return $("<div>").append(moment(value).format("YYYY-MM-DD HH:mm:ss"));
                        }  
                    },
                    { name: "updatedDate", title: "Updated Date", type: "text", width: 200, readOnly:true,
                        itemTemplate: function(value) {
                            return $("<div>").append(moment(value).format("YYYY-MM-DD HH:mm:ss"));
                        }  
                     },
                    { name: "isDone", type: "checkbox", title: "Done", sorting: false },
                    {
                        type: "control",
                        modeSwitchButton: false,
                        editButton: false,
                        headerTemplate: function() {
                            return $("<button>").attr("type", "button").text("Add")
                                    .on("click", function () {
                                        showDetailsDialog("Add", {});
                                    });
                        }
                    }
                ],
                // onItemInserting: function(args) {
                //     alert("onItemInserting");
                // },
                // onItemUpdating: function(args) {
                //     alert("onItemUpdating");
                // },
                // onItemDeleting: function(args) {
                //     alert("onItemDeleting");
                // },
                // onPageChanged: function(args) {
                //     alert("onPageChanged");
                // },
                // onDataLoading: function(args) {
                //     alert("onDataLoading");
                // },
                deleteConfirm: function(item) {
                    return "The client \"" + item.Name + "\" will be removed. Are you sure?";
                },
                rowClick: function(args) {
                    showDetailsDialog("Edit", args.item);
                }
            });

            $("#detailsDialog").dialog({
                autoOpen: false,
                width: 400,
                close: function() {
                    $("#detailsForm").validate().resetForm();
                    $("#detailsForm").find(".error").removeClass("error");
                }
            });

            $("#detailsForm").validate({
                rules: {
                    task: { 
                        required: true
                    }
                },
                messages: {
                    task: "vaildation failed"
                },
                submitHandler: function() {
                    formSubmitHandler();
                }
            });

            var formSubmitHandler = $.noop;
 
            var showDetailsDialog = function(dialogType, todo) {
                $("#todoId").val(todo.todoId);
                $("#task").val(todo.task);
                $("#referenceIds").val(todo.referenceIds);
                $("#createdDate").val(moment(todo.createdDate).format("YYYY-MM-DD HH:mm:ss"));
                $("#updatedDate").val(moment(todo.updatedDate).format("YYYY-MM-DD HH:mm:ss"));    
                $("#isDone").prop("checked", todo.isDone);

                formSubmitHandler = function() {
                    if(/^(\d|,)*\.?\d*$/.test($("#referenceIds").val())){
                        var array = $("#referenceIds").val().split(",").map(Number);
                        var index = array.indexOf(parseInt($("#todoId").val()));
                        if(index === -1){
                            saveClient(todo, dialogType === "Add");
                        }else{
                            $("#detailsForm").validate().resetForm();
                            alert("fail!!");
                        }
                    }else{
                        $("#detailsForm").validate().resetForm();
                        alert("fail!!");
                    }
                    
                };

                $("#detailsDialog").dialog("option", "title", dialogType + " Client").dialog("open");
            };

            var saveClient = function(todo, isNew) {
                $.extend(todo, {
                    todoId: parseInt($("#todoId").val(), 10),
                    task: $("#task").val(),
                    referenceIds: $("#referenceIds").val()? $("#referenceIds").val().split(",").map(Number) : null,
                    createdDate: isNew ? new Date().getTime() : todo.createdDate,
                    updatedDate: new Date().getTime(),
                    isDone: $("#isDone").is(":checked")
                });
        
                $("#jsGrid").jsGrid(isNew ? "insertItem" : "updateItem", todo);
        
                $("#detailsDialog").dialog("close");
            };

            $("#testBtn").on("click", function(){
                var searchCondition = {
                    task: $("#search-task").val(),
                    createdDate: $("#search-createdDate").val() ? new Date($("#search-createdDate").val()).getTime() : null,
                    updatedDate: $("#search-updatedDate").val() ? new Date($("#search-updatedDate").val()).getTime() : null
                }
                $("#jsGrid").jsGrid("loadData", searchCondition).done(function() {
                    console.log("data loaded");
                });
            });
        });
    </script>
</html>